#!/usr/bin/python
# -*- coding:utf-8 -*-
import sys
import os
picdir = os.path.join(os.path.dirname(os.path.dirname(os.path.realpath(__file__))), 'pic')
libdir = os.path.join(os.path.dirname(os.path.dirname(os.path.realpath(__file__))), 'lib')
if os.path.exists(libdir):
    sys.path.append(libdir)

import logging
from waveshare_epd import epd2in7
import time
from PIL import Image, ImageDraw, ImageFont
import qrcode
from datetime import datetime
import uuid

logging.basicConfig(level=logging.DEBUG)

# --- ★重要★ ---
# この部分をあなたのRaspberry PiのIPアドレスに変更してください
SERVER_IP = "192.168.100.18" 
# -----------------

epd = None

def display_message(epd, font, message):
    """画面中央にメッセージを表示する関数"""
    image = Image.new('1', (epd.width, epd.height), 255)
    draw = ImageDraw.Draw(image)
    
    # テキストのサイズを取得して中央揃えにする
    bbox = draw.textbbox((0,0), message, font=font)
    text_width = bbox[2] - bbox[0]
    text_height = bbox[3] - bbox[1]
    #text_width, text_height = draw.textsize(message, font=font)
    x = (epd.width - text_width) // 2
    y = (epd.height - text_height) // 2
    
    draw.text((x, y), message, font=font, fill=0)
    epd.display(epd.getbuffer(image))

try:
    epd = epd2in7.EPD()
    epd.init()
    epd.Clear(0xFF)

    font_path = os.path.join(picdir, 'Font.ttc')
    if os.path.exists(font_path):
        font_info = ImageFont.truetype(font_path, 14)
        font_main = ImageFont.truetype(font_path, 18)
        font_success = ImageFont.truetype(font_path, 24)
    else:
        font_info = ImageFont.load_default()
        font_main = ImageFont.load_default()
        font_success = ImageFont.load_default()

    user_id = "user-t-8821"

    while True:
        # --- 1. 新しいQRコードの準備 ---
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        # 各QRコードをユニークに識別するためのIDを生成
        qr_id = str(uuid.uuid4().hex)[:8]
        
        # QRコードに含めるURLを生成
        qr_data_url = f"http://{SERVER_IP}:5000/scan?user_id={user_id}&qr_id={qr_id}"
        logging.info(f"Generated QR Code URL: {qr_data_url}")

        qr = qrcode.QRCode(version=1, error_correction=qrcode.constants.ERROR_CORRECT_L, box_size=4, border=4)
        qr.add_data(qr_data_url)
        qr.make(fit=True)
        qr_img = qr.make_image(fill_color="black", back_color="white")

        # --- 2. e-paperにQRコードと情報を表示 ---
        canvas = Image.new('1', (epd.width, epd.height), 255)
        draw = ImageDraw.Draw(canvas)
        draw.text((10, 5), "User ID:", font=font_info, fill=0)
        draw.text((10, 21), user_id, font=font_main, fill=0)
        draw.text((10, 47), "Timestamp:", font=font_info, fill=0)
        draw.text((10, 63), timestamp, font=font_info, fill=0)
        draw.text((10, 89), f"(QR ID: {qr_id})", font=font_info, fill=0)
        
        qr_size = 140
        qr_img_resized = qr_img.resize((qr_size, qr_size))
        qr_x = (epd.width - qr_size) // 2
        qr_y = epd.height - qr_size
        canvas.paste(qr_img_resized, (qr_x, qr_y))

        epd.display(epd.getbuffer(canvas))

        # --- 3. QRコードがスキャンされるのを待つ ---
        flag_filename = f"scanned_{qr_id}.flag"
        timeout_seconds = 10
        is_scanned = False
        
        logging.info(f"Waiting for scan... (Timeout: {timeout_seconds}s)")
        for _ in range(timeout_seconds):
            if os.path.exists(flag_filename):
                logging.info("QR Code has been scanned!")
                is_scanned = True
                os.remove(flag_filename) # フラグファイルを削除
                break
            time.sleep(1)

        # --- 4. 結果を表示 ---
        if is_scanned:
            display_message(epd, font_success, "読み取り成功！")
            time.sleep(5) # 成功メッセージを5秒間表示
        else:
            logging.info("Timeout. Generating new QR code.")
            # タイムアウトした場合、メッセージは表示せずに次のループへ
        
        epd.Clear(0xFF) # 次の表示のために画面をクリア

except IOError as e:
    logging.error(e)
except KeyboardInterrupt:
    logging.info("ctrl + c:")
    if epd is not None:
        epd.Clear(0xFF)
        epd.sleep()
    # 存在する可能性のあるフラグファイルを削除
    import glob
    for f in glob.glob("scanned_*.flag"):
        os.remove(f)
    epd2in7.epdconfig.module_exit(cleanup=True)
    exit()

